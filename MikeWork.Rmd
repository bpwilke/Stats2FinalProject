---
title: "MikeWork"
author: "Michael Landrum"
date: "4/3/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading, include=FALSE, echo=FALSE}
library(kableExtra) # to make uber sexy tables for output
library(pastecs) # for easy descriptive statistics
#library(ggbiplot) # implementation of biplot using ggplot2 for plotting PCs
library(Amelia) # cool library for exploring missing data
library(ROCR) # for ROC plots and AUC calculations

setwd("~/Documents/Stats2FinalProject")

BBHOFRaw <- read.table("MLBHOF-tab.new.dat.txt", sep="\t", header=FALSE)

colnames(BBHOFRaw) <- c("Name","NumSeasonsPlayed", "GamesPlayed", 
                        "OfficialAtBats", "RunsScored", "Hits", "Doubles", "Triples", 
                        "HomeRuns", "RunsBattedIn", "Walks", "Strikeouts", "BattingAvg", 
                        "OnBasePct", "SluggingPct", "AdjustedProduction", "BattingRuns", 
                        "AdjustedBattingRuns", "RunsCreated", "StolenBases", "CaughtStealing", 
                        "StolenBaseRuns", "FieldingAvg", "FieldingRuns", "PrimaryPositionPlayed", 
                        "TotalPlayerRating", "HOFMembership")
colsNoName <- c("NumSeasonsPlayed", "GamesPlayed", 
                        "OfficialAtBats", "RunsScored", "Hits", "Doubles", "Triples", 
                        "HomeRuns", "RunsBattedIn", "Walks", "Strikeouts", "BattingAvg", 
                        "OnBasePct", "SluggingPct", "AdjustedProduction", "BattingRuns", 
                        "AdjustedBattingRuns", "RunsCreated", "StolenBases",  
                        "FieldingAvg", "FieldingRuns", "PrimaryPositionPlayed", 
                        "TotalPlayerRating", "HOFMembership")
                        
BBHOFRaw$Name <- as.character(BBHOFRaw$Name)

BBHOFRaw$Strikeouts[BBHOFRaw$Strikeouts == "."] <- NA
BBHOFRaw$Strikeouts <- as.integer(BBHOFRaw$Strikeouts)

BBHOFRaw$StolenBases[BBHOFRaw$StolenBases == "."] <- NA
BBHOFRaw$StolenBases <- as.integer(BBHOFRaw$StolenBases)

BBHOFRaw$CaughtStealing[BBHOFRaw$CaughtStealing == "."] <- NA
BBHOFRaw$CaughtStealing <- as.integer(BBHOFRaw$CaughtStealing)

BBHOFRaw$StolenBaseRuns[BBHOFRaw$StolenBaseRuns == "."] <- NA
BBHOFRaw$StolenBaseRuns <- as.integer(BBHOFRaw$StolenBaseRuns)

df1 <- BBHOFRaw
df1$Other <- df1$HOFMembership
df0 <- df1

df1$HOFMembership[df1$HOFMembership == 2] <- 1

## to print the accuracy of a logistic model
get_accuracy <- function(BBHOF_logistic){
  set.seed(100) 
  sample <- sample.int(n=nrow(BBHOF_logistic), size=floor(.90*nrow(BBHOF_logistic)), replace=FALSE)
  train <- BBHOF_logistic[sample, ]
  test  <- BBHOF_logistic[-sample, ]
  model <- glm(train$HOFMembership ~., family=binomial(link='logit'),data=train)
  fittedresults <- predict(model, newdata=test, type='response')
  fittedresults <- ifelse(fittedresults > 0.5, 1, 0)
  misClasificError <- mean(fittedresults != test$HOFMembership, na.rm=TRUE) 
  print(paste('Accuracy',1-misClasificError))
}


```

## Adding onto your work

Ideally we find a model that doesn't use categories we can't easily grab for current players. Unfortunately "TotalPlayerRating" was one of the best predictors for HoF, which makes sense since that was likely the goal of the stat: to determine how good the player is. With this in mind, we wanted to see how they come up with this stat, and if we could proceed without it. 

We created a multiple linear regression model using the categories we can easily get off the web for current players vs this Total Player Rating.

```{r tpr, echo=TRUE}

tpr <- lm(TotalPlayerRating ~ OfficialAtBats + RunsScored + Hits + Doubles + Triples +
            HomeRuns + RunsBattedIn + Walks + Strikeouts + BattingAvg + OnBasePct +
            SluggingPct + StolenBases + CaughtStealing, data=BBHOFRaw)

summary(tpr)

```

So as we were hoping (and a little expected), this stat is basically a linear combinations of the basic stats plus some defense adjustment (r^2 jumps to 0.8394 when adding fielding runs) and then ballpark/era adjustments that we can't really get. But this is pretty good news because we can likely toss TotalPlayerRating and get good results.

K so with that, we want to just look at the "basic stats" and create a model using those. Here are those columns and then created a new DF using them. (Removed caught steeling due to the high number of NAs)


```{r goodCols, echo=TRUE}

basic <- c( 
  "OfficialAtBats", "RunsScored", "Hits",
  "HomeRuns", "RunsBattedIn", "BattingAvg", 
  "OnBasePct", "SluggingPct", "StolenBases", 
  "HOFMembership") 

df1basic <- df1[, basic]

```

And then using your code to get an accuracy percentage:

```{r newModel1, echo=FALSE}

get_accuracy(df1basic)

```

A very close 94.77%! But I think there's some cheating going on here. Basically like 1% of players are HoF (I'm making this number up), so any model will get 90%+ if they just said no to everyone. So I'm not completely sure this model is as good. It's also VERY odd to me that batting average doesn't play a huge roll in this as I'm pretty sure that and Home Runs were the only categories people cared about back in the day.

Then we realized it had to do with the amount of at bats. We have a bunch of guys in here with good batting averages but didn't play long enough to get into the HoF. As it turns out, we have a lot of players who didn't play long enough to really be a serious HoF candidate. So we probably want to restrict our data set to players with 6000+ at bats (vast majority of HoF fit this criteria).

Here's the accuracy percentage, including all variables, but just for players with 6000+ at bats, followed by the new model with just the basic stats.

```{r newModel2, echo=FALSE}

## just players with 6000+ at bats, but with all the non-name columns
df1all6k <- df1[ df1$OfficialAtBats>6000, colsNoName]
df1basic6k <- df1basic[ df1basic$OfficialAtBats>6000, ]

get_accuracy(df1all6k)
get_accuracy(df1basic6k)


```

So, in this seed the basic stats actually performed better. We should be able to proceed without the TotalPlayerRating or the other non-box score statistics in our model. 

### Insert Code where you checked to see how many HoF we got rid of at 6000 at bats. Say something like "as a double check we didn't kill our data set .. "

Getting rid of 24 HoF with less than 6000 at bats felt a little off. Upon further research, we realized that the players with a "2" in HOFMembership were Hall of Famers, but they were elected in a different manor. They were selected after their 15 years expired and by the "Veteran's Committee". Some of these players made it for other reasons outside of their statistics such as a good managerial career.

So, this could possibly explain the innaccuracy of our model. To check this, we ran another logistic model on the entire data set and then predicted HoF based on this model and then checked the False Negatives. That is, we checked whether a player was actually in the HoF but our model predicted they wouldn't be.

```{r falseNegs, echo=FALSE}

df1all <- df1[ , colsNoName]

model <- glm(df1all$HOFMembership ~. , family=binomial(link='logit'),data=df1all)
fittedresults <- predict(model, newdata=df1all, type='response')
fittedresults <- ifelse(fittedresults > 0.5, 1, 0)
df1$guess <- fittedresults
hof1 <- df1[ df1$HOFMembership ==1 ,   ]
falseNegs <- hof1[ hof1$guess == 0,  ]

#falseNegs <- falseNegs[complete.cases(falseNegs), ]

nrow(falseNegs)
nrow(falseNegs[ falseNegs$Other==2 , ])

```

28 of the 35 false negatives were due to being elected by the veteran's committee. For the purpose of our initial question of "Out of the current HoF candidates, who will get elected to the HoF?", we don't want to use the ones voted in later. 

So our final model will have us change the "2" from the HoFMembership column to "0", will only use the basic stats, and base it on players who have 6000 at bats. We are also going to change the column names so that they will be easily used for future data sets.

```{r model, echo=FALSE}

df0$HOFMembership[df0$HOFMembership == 2] <- 0
df0basic <- df0[ df0$OfficialAtBats > 6000 , basic ]

basic_abbrev <- c( 
  "AB", "R", "H",
  "HR", "RBI", "BA", 
  "OBP", "SLG", "SB", 
  "HOF") 

colnames(df0basic) <- basic_abbrev


model <- glm(df0basic$HOF ~. , family=binomial(link='logit'),data=df0basic)

```

Now we want to look at the players who are currently being voted on by the HoF committee. We extracted the list and their stats manually from baseballreference.com.

```{r HoFcand, echo=FALSE}

col <- c( 
  "AB", "R", "H",
  "HR", "RBI", "BA", 
  "OBP", "SLG", "SB") 

HoFcand <- read.csv("OnHoFBallot.csv")[ , col]

HOF <- predict(model, newdata=HoFcand, type='response')
#HOF <- ifelse(fittedresults > 0.5, 1, 0)
HoFcand$HOF <- round(HOF,3)

HoFcand <- HoFcand[ order(HoFcand$HOF), ]

HoFcand


```